#!/usr/bin/env bash

# SamuraiSight network setting configuration utility. NOTE: CHANGES WILL NOT TAKE EFFECT UNTIL SAMURAISIGHT IS RESTARTED

# Usage: ./bin/netconfig <opts>
# Opts: -d sets IP to DHCP, -s sets static IP (requires 1 argument),

cd /opt/SamuraiSight/

DETECTED_NETMNGR=UNKNOWN
if 
set -a
source .env
set +a

# command line opts parsing
while getopts "ds:" opt; do
    case $opt in
        d )
            sed -i "s/^USE_STATIC_IP=.*/USE_STATIC_IP=false/" ".env" 
            sed -i "s/^STATIC_IP=.*/STATIC_IP=/" ".env" 
            case $NETMNGR in
                NETWORK_D )
                    # Code goes here
                    NETWORK_FILE="/etc/systemd/network/10-smsight-eth0.network"
                    if ! [ -f $NETWORK_FILE ]; then
                        cat > $NETWORK_FILE <<EOF
;SamuraiSight Network Configuration File. DO NOT MODIFY THIS MANUALLY
[Match]
Name=eth0

[Network]
DHCP=yes
;Address=
Gateway=_dhcp4
EOF
                    else
                        sed -i "s/^DHCP=.*/DHCP=yes/" $NETWORK_FILE
                        sed -i "s/^Address=.*/;Address=/" $NETWORK_FILE
                        sed -i "s/^Gateway=.*/Gateway=_dhcp4" $NETWORK_FILE
                    fi
                    ;;
                NETWORK_MANAGER )
                    # Network manager support is WIP, and when network manager is detected SamuraiSight defaults to its built-in network management system. Ditto for dhcpcd
                    exit 0
                    ;;
                DHCPCD )
                    exit 0
                    ;;   
            esac
            ;;
        s )
            sed -i "s/^STATIC_IP=.*/STATIC_IP=$OPTARG/" ".env"
            sed -i "s/^USE_STATIC_IP=.*/USE_STATIC_IP=true" ".env"
            case $NETMNGR in
                NETWORK_D )
                    # Code goes here
                    NETWORK_FILE="/etc/systemd/network/10-smsight-eth0.network"
                    if ! [ -f $NETWORK_FILE ]; then
                        cat > $NETWORK_FILE <<EOF
;SamuraiSight Network Configuration File. DO NOT MODIFY THIS MANUALLY
[Match]
Name=eth0

[Network]
DHCP=no
Address=$OPTARG/24
Gateway=$GATEWAY
EOF
                    sed -i "s/^DHCP=.*/DHCP=no/" $NETWORK_FILE
                    sed -i "s/^;Address=/Address=/" $NETWORK_FILE
                    sed -i "s/^Address=.*/Address=$OPTARG\/24" $NETWORK_FILE
                    sed -i "s/^Gateway=.*/Gateway=$GATEWAY" $NETWORK_FILE
                    ;;
                NETWORK_MANAGER )
                    # Network manager support is WIP, and when network manager is detected SamuraiSight defaults to its built-in network management system. Ditto for dhcpcd
                    exit 0
                    ;;
                DHCPCD )
                    exit 0
                    ;;   
            esac
            ;;
    esac

        